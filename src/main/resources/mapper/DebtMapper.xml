<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cheongsan.domain.debt.mapper.DebtMapper">

    <!-- 총 대출 항목 조회-->
    <select id="getUserDebtList" parameterType="long" resultType="cheongsan.domain.debt.dto.DebtInfoResponseDTO">
        SELECT da.id                AS debtId,
               da.debt_name         AS debtName,
               fi.organization_name AS organizationName,
               da.current_balance   AS currentBalance,
               da.original_amount   AS originalAmount,
               da.interest_rate     AS interestRate,
               da.loan_start_date   AS loanStartDate
        FROM debt_accounts da
                 JOIN financial_institutions fi ON da.organization_code = fi.organization_code
        WHERE da.user_id = #{userId}
    </select>

    <!-- 대출별 상세 조회-->
    <select id="getLoanDetail" parameterType="long" resultType="cheongsan.domain.debt.dto.DebtDetailResponseDTO">
        SELECT da.debt_name           AS debtName,
               fi.organization_name   AS organizationName,
               da.original_amount     AS originalAmount,
               da.interest_rate       AS interestRate,
               da.loan_start_date     AS loanStartDate,
               da.current_balance     AS currentBalance,
               da.grace_period_months AS gracePeriodMonths,
               da.repayment_method    AS repaymentMethod
        FROM debt_accounts da
                 JOIN financial_institutions fi ON da.organization_code = fi.organization_code
        WHERE da.id = #{loanId}
    </select>

    <select id="findByUserId" resultType="cheongsan.domain.debt.entity.DebtAccount">
        SELECT id,
               user_id,
               organization_code,
               res_account,
               debt_name,
               current_balance,
               original_amount,
               interest_rate,
               loan_start_date,
               loan_end_date,
               next_payment_date,
               grace_period_months,
               repayment_method
        FROM debt_accounts
        WHERE user_id = #{userId}
    </select>

    <insert id="insertDebt" parameterType="cheongsan.domain.debt.entity.DebtAccount">
        INSERT INTO debt_accounts (user_id, organization_code, res_account, debt_name, current_balance,
                                   original_amount, interest_rate, loan_start_date, loan_end_date, next_payment_date,
                                   grace_period_months, repayment_method, created_at, updated_at)
        VALUES (#{userId}, #{organizationCode}, #{resAccount}, #{debtName}, #{currentBalance},
                #{originalAmount}, #{interestRate}, #{loanStartDate}, #{loanEndDate}, #{nextPaymentDate},
                #{gracePeriodMonths}, #{repaymentMethod}, #{createdAt}, #{updatedAt})
    </insert>


    <!-- 추가할 대출 계좌 중복 확인 -->
    <select id="isDebtAccountExists" resultType="boolean" parameterType="map">
        SELECT EXISTS (SELECT 1
                       FROM debt_accounts
                       WHERE user_id = #{userId}
                         AND res_account = #{resAccount})
    </select>

    <select id="getMonthlyRepayments" resultType="cheongsan.domain.debt.dto.RepaymentCalendarDTO">
        SELECT da.id                AS debtId,
               da.debt_name         AS debtName,
               da.next_payment_date AS repaymentDate
        FROM debt_accounts da
        WHERE da.user_id = #{userId}
          AND YEAR(da.next_payment_date) = #{year}
          AND MONTH(da.next_payment_date) = #{month}
          AND da.next_payment_date IS NOT NULL
        ORDER BY da.next_payment_date ASC
    </select>

    <select id="getDailyRepayments" resultType="cheongsan.domain.debt.dto.DailyRepaymentDTO">
        SELECT da.id                AS debtId,
               da.debt_name         AS debtName,
               fi.organization_name AS organizationName,
               da.next_payment_date AS repaymentDate,
               da.current_balance   AS currentBalance,
               da.interest_rate     AS interestRate,
               da.repayment_method  AS repaymentMethod
        FROM debt_accounts da
                 JOIN financial_institutions fi ON da.organization_code = fi.organization_code
        WHERE da.user_id = #{userId}
          AND DATE(da.next_payment_date) = #{date}
          AND da.next_payment_date IS NOT NULL
        ORDER BY da.debt_name ASC
    </select>

    <select id="getDebtRepaymentInfoByUserId" parameterType="long"
            resultType="cheongsan.domain.debt.entity.DebtRepaymentRatio">
        SELECT user_id,
               original_amount,
               current_balance
        FROM debt_accounts
        WHERE user_id = #{userId}
    </select>

    <select id="getDelinquentLoanByUserId" parameterType="long"
            resultType="cheongsan.domain.debt.entity.DelinquentLoan">
        SELECT da.debt_name         AS debtName,
               fi.organization_name AS organizationName,
               da.next_payment_date AS nextPaymentDate
        FROM debt_accounts da
                 JOIN financial_institutions fi ON da.organization_code = fi.organization_code
        WHERE da.user_id = #{userId}
          AND da.next_payment_date &lt; CURRENT_DATE
          AND NOT EXISTS (SELECT 1
                          FROM debt_transactions dt
                          WHERE dt.debt_account_id = da.id
                            AND dt.transaction_date &gt;= da.next_payment_date)
    </select>

</mapper>
